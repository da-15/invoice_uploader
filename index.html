<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" >
    <title>レシート取込</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" type="image/png" href="./assets/icon.png">
    <link rel="apple-touch-icon" href="./assets/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="./assets/android-touch-icon.png" sizes="192x192">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1/i18n/jquery.ui.datepicker-ja.min.js"></script>
    
    <style type="text/css">
      html {
        font-size: 62.5%;
      }
      body {
        font-size: 2.0rem;
        margin: 0px;
        text-align: center;
        color: #333;
        font-family: "Open Sans", "游ゴシック体", YuGothic, "游ゴシック Medium", "Yu Gothic Medium", "游ゴシック", "Yu Gothic", sans-serif;
      }
      a {
        color: #97abc3;
      }
      @media (max-width: 670px) {
        /* スマホ */
        main {
            margin: 0 auto;
            width: 100%;
        }
        .cp_button, .cp_file{
          width: 80%;
        }
      }
      @media (max-width: 1100px) and (min-width: 671px) {
        /* タブレット */
        main {
            margin: 0 auto;
            width: 671px;
        }
        .cp_button, .cp_file{
          width: 400px;
        }
      }
      @media (min-width: 1101px) {
        /* パソコン */
        main {
            margin: 0 auto;
            width: 671px;
        }
        .cp_button, .cp_file{
          width: 400px;
        }
      }
      .cp_contents {
        margin: 20px;
      }

      /* インプット */
      .cp_input {
        margin: 10px 0px;
        box-sizing: border-box;
        width: 100%;
        padding: 1.5rem;
        letter-spacing: 1px;
        color: #333;
        border: 1px solid #97abc3;
        border-radius: 1vh;
        font-size: 2.0rem;
        font-family: "Open Sans", "游ゴシック体", YuGothic, "游ゴシック Medium", "Yu Gothic Medium", "游ゴシック", "Yu Gothic", sans-serif;
        outline: none;
      }
      .cp_input:read-only{
        background-color: #dedede;
      }

      /* ボタン */
      .cp_fileinput{
        display: none;
      }
      .cp_button, .cp_file{
        display: inline-block;
        -webkit-appearance: none;
        margin: 10px 0px;
        color: #fff;
        background-color: #97abc3;
        border-radius: 5vh;
        border: 0px;
        padding: 1.8rem 0rem;
        font-size: 2.0rem;
        font-family: "Open Sans", "游ゴシック体", YuGothic, "游ゴシック Medium", "Yu Gothic Medium", "游ゴシック", "Yu Gothic", sans-serif;
        outline: none;
      }
      .cp_button:disabled{
        background-color: #7d7d7d;
      }
      .cp_button:active {
        background-color: #9aaeb6;
        outline: none;
      }

      /* チェックボックス */
      .cp_checkbox {
        font-size: 1.5rem;
        color: #888;
      }
      input[type=checkbox] {
        display: none;
      }
      .cp_checkbox {
        box-sizing: border-box;
        cursor: pointer;
        display: inline-block;
        padding: 5px 30px;
        position: relative;
        width: auto;
      }
      .cp_checkbox::before {
        background: #fff;
        border: 1px solid #888;
        content: '';
        display: block;
        height: 16px;
        width: 16px;
        left: 5px;
        margin-top: -8px;
        position: absolute;
        top: 50%;
      }
      .cp_checkbox::after {
        border-right: 3px solid #97abc3;
        border-bottom: 3px solid #97abc3;
        content: '';
        display: block;
        height: 9px;
        left: 10px;
        margin-top: -7px;
        opacity: 0;
        position: absolute;
        top: 50%;
        transform: rotate(45deg);
        width: 5px;
      }
      input[type=checkbox]:checked+.cp_checkbox::after {
        opacity: 1;
      }

      /* セレクト */
      .cp_select {
        display: inline-flex;
        align-items: center;
        position: relative;
      }
      .cp_select::after {
          position: absolute;
          right: 15px;
          width: 10px;
          height: 7px;
          background-color: #535353;
          clip-path: polygon(0 0, 100% 0, 50% 100%);
          content: '';
          pointer-events: none;
      }
      .cp_select select {
          appearance: none;
          min-width: 230px;
          height: 2.8em;
          padding: .4em calc(.8em + 30px) .4em .8em;
          border: 1px solid #97abc3;
          outline: 0px;
          border-radius: 1vh;
          background-color: #fff;
          color: #333;
          font-size: 1.7rem;
          cursor: pointer;
      }
    </style>
    <script type="text/javascript">
      $(function () {
        //日付の初期値をセット
        const today = new Date();
        const jst = new Date(today.getTime() + 9 * 60 * 60 * 1000);
        $('#date').val(jst.toISOString().substring(0, 10));

        //日付選択ダイアログ
        $.datepicker.setDefaults($.datepicker.regional['ja']);
        $('#date').datepicker({ dateFormat: 'yy-mm-dd' });

        //セレクトが選択された
        $('#preset').on('change', function () {
            //テンプレート適用
            $('#memo').val( $('#preset').val());
        });

        //画像選択時にアップロード用情報をセット
        $('#fileinput').on('change', function () {
          let file = this.files[0];
          let fr = new FileReader();
          fr.onload = function (e) {
            $('#filename').val(file.name); //ファイル名
            $('#filetype').val(file.type); //MIME Type
            $('#fileuri').val(e.target.result.replace(/^.*,/, ''));
          };
          fr.readAsDataURL(file);
        });
      });

      //SUBMITボタン押下時にファイルをアップロードする
      function sendFile(){
        //入力チェック
        if(!checkForm()){
          return false;
        }

        const form = document.querySelector('form');
        const xhr = new XMLHttpRequest();
        xhr.open('POST', form.action);

        // フォームデータを取得し、送信する
        const formData = new FormData(form);
        xhr.send(formData);
        setFormDisabled(true);

        // レスポンスが受信された場合の処理
        xhr.onload = () => {
          if (xhr.status === 200) {
            alert(xhr.response); // レスポンスの内容を表示する
          } else {
            alert('リクエストが失敗しました: ' + xhr.status);
          }
          setFormDisabled(false);
        };
        //actionに遷移させない
        return false;
      }
      function checkForm(){
        if($('#date').val() == '' || 
           $('#memo').val() == '' || 
           $('#fileuri').val() == '' || 
           $('#price').val() == ''){
            alert('【必須項目エラー】\n入力されていない項目があります。');
            return false;
        } else{
          return true;
        }

      }

      //入力フォームを入力可/不可切替
      function setFormDisabled(lock) {
        $('#date').prop('readonly', lock);
        $('#memo').prop('readonly', lock);
        $('#price').prop('readonly', lock);

        $('#preset').prop('disabled', lock);
        $('#fileinput').prop('disabled', lock);
        $('#upload_button').prop('disabled', lock);
      }
    </script>
  </head>
  <body>
    <main class="cat_top">
      <div class="cp_contents">
      <form method="post"
        action="https://script.google.com/macros/s/AKfycbw6DhFdeqjNh85-oKD5dMznZYwsHnHY88MWPO2Ya8bOX7kRzfQAYRGtGIdoDSbpA5NbpQ/exec"
        onsubmit="return sendFile();">
      <p>
      <table width="100%">
        <td align="left">レシートの取引情報</td>
        <td align="right"><a href="https://myaccount.google.com/" target="_blank"><small>ログイン</small></a></td>
      </table>
      <input type="text" name="date" id="date"  class="cp_input">
      </p>
      <p>
        <label class="cp_select">
          <select name="preset" id="preset">
              <option value="">―― 支払先を選択してください ――</option>
              <option value="TEPCO（●月20日〜●月19日分）">TEPCO</option>
              <option value="東京水道局（●、●、●月分）">東京水道局</option>
              <option value="KDDI（●月分 ●月請求分）">KDDI</option>
              <option value="GMOインターネット（●月分）">GMOインターネット</option>
              <option value="●（会議）">会議</option>
              <option value="">その他</option>
          </select>
      </label>
        <input type="text" name="memo" id="memo" placeholder="支払先の備考を入力してください" class="cp_input"><br>
        <input type="number" name="price" id="price" class="cp_input" min="1" max="99999" placeholder="価格（税込）を入力してください">
      </p>
      <p>
        <input type="text" id="filename" class="cp_input" placeholder="画像を選択してください" readonly><br>
        <input type="file" id="fileinput" class="cp_fileinput">
        <label for="fileinput" class="cp_file">画像を選択</label><br>
        <input type="submit" value="アップロードする" id="upload_button" class="cp_button"><br>
        <input type="checkbox" name="resize" id="resize">
        <label for="resize" class="cp_checkbox">画像をリサイズしない</label>
      </p>
      <a href="./"><small>クリアする</small></a><br>
      <input type="hidden" name="fileuri" id="fileuri">
      <input type="hidden" name="filetype" id="filetype">
    </form>
    </div>
    </main>
  </body>
</html>
